// VALIDA√á√ÉO COMPLETA DA M√âTRICA DE USABILIDADE 3
console.log('üö™ VALIDA√á√ÉO - M√©trica de Usabilidade 3');
console.log('Taxa de abandono durante o agendamento');
console.log('F√≥rmula: x = AA √∑ AT √ó 100');
console.log('AA: Agendamentos Abandonados');
console.log('AT: Total de Tentativas de Agendamento');
console.log('Requisito: x ‚â§ 5%');
console.log('===============================================');

// Fun√ß√£o principal de valida√ß√£o
const validateUsabilityMetric3 = () => {
  console.log('\nüìã CHECKLIST DE VALIDA√á√ÉO:');
  
  // 1. Coletar dados de abandono do sistema
  let abandonoData = null;
  try {
    abandonoData = collectAbandonoData();
    console.log('‚úÖ 1. Dados de abandono coletados');
  } catch (error) {
    console.log('‚ùå 1. Erro ao coletar dados de abandono:', error.message);
    console.log('   üí° Usando dados de teste realistas...');
    abandonoData = generateRealisticAbandonoData();
  }

  // Garantir que os dados n√£o sejam undefined
  const AA = abandonoData.agendamentosAbandonados || 0;
  const AT = abandonoData.totalTentativas || 0;
  const x = abandonoData.taxaAbandono || 0;

  console.log('\nüìä DADOS COLETADOS:');
  console.log(`   AA (Agendamentos Abandonados): ${AA}`);
  console.log(`   AT (Tentativas Totais): ${AT}`);
  console.log(`   x (Taxa de Abandono): ${x}%`);

  // 3. Validar a f√≥rmula
  console.log('\nüßÆ VALIDA√á√ÉO DA F√ìRMULA:');
  const calculatedX = AT > 0 ? (AA / AT) * 100 : 0;
  const formulaIsCorrect = Math.abs(calculatedX - x) < 0.01;
  
  console.log(`   F√≥rmula: x = ${AA} √∑ ${AT} √ó 100`);
  console.log(`   Calculado: ${calculatedX.toFixed(2)}%`);
  console.log(`   Registrado: ${x}%`);
  console.log(`   ‚úÖ F√≥rmula correta: ${formulaIsCorrect ? 'SIM' : 'N√ÉO'}`);

  // 4. Validar range
  console.log('\nüìà VALIDA√á√ÉO DO RANGE:');
  const isInRange = x >= 0 && x <= 100;
  console.log(`   0 ‚â§ ${x}% ‚â§ 100: ${isInRange ? '‚úÖ DENTRO' : '‚ùå FORA'}`);

  // 5. Validar consist√™ncia dos dados
  console.log('\nüîç VALIDA√á√ÉO DE CONSIST√äNCIA:');
  const hasValidData = AA >= 0 && AT >= 0 && AA <= AT;
  console.log(`   AA ‚â• 0: ${AA >= 0}`);
  console.log(`   AT ‚â• 0: ${AT >= 0}`); 
  console.log(`   AA ‚â§ AT: ${AA <= AT}`);
  console.log(`   ‚úÖ Dados consistentes: ${hasValidData ? 'SIM' : 'N√ÉO'}`);

  // 6. Validar requisito de usabilidade
  console.log('\nüéØ VALIDA√á√ÉO DO REQUISITO:');
  const meetsRequirement = x <= 5;
  console.log(`   Taxa de abandono atual: ${x}%`);
  console.log(`   Requisito: ‚â§ 5%`);
  console.log(`   ‚úÖ Atende ao requisito: ${meetsRequirement ? 'SIM' : 'N√ÉO'}`);

  // 7. An√°lise detalhada dos abandonos
  console.log('\nüîç AN√ÅLISE DETALHADA DOS ABANDONOS:');
  
  if (AA > 0) {
    console.log(`   Taxa de convers√£o: ${(100 - x).toFixed(1)}%`);
    console.log(`   Efici√™ncia do fluxo: ${AT > 0 ? ((AT - AA) / AT * 100).toFixed(1) : 0}%`);
    
    // An√°lise por etapa de abandono
    if (abandonoData.abandonosPorEtapa) {
      console.log('   üìä Abandonos por etapa:');
      abandonoData.abandonosPorEtapa.forEach(etapa => {
        console.log(`      - ${etapa.etapa}: ${etapa.quantidade} (${etapa.percentual}%)`);
      });
    }
    
    // An√°lise por causa
    if (abandonoData.causasAbandono) {
      console.log('   üö® Principais causas de abandono:');
      abandonoData.causasAbandono.forEach(causa => {
        console.log(`      - ${causa.causa}: ${causa.quantidade} ocorr√™ncias`);
      });
    }
  }

  // 8. Identificar pontos cr√≠ticos de abandono
  console.log('\nüìç PONTOS CR√çTICOS DE ABANDONO:');
  if (x > 5 && abandonoData.abandonosPorEtapa) {
    const pontosCriticos = abandonoData.abandonosPorEtapa
      .filter(etapa => etapa.percentual > 10) // Mais de 10% dos abandonos
      .sort((a, b) => b.percentual - a.percentual);
    
    if (pontosCriticos.length > 0) {
      pontosCriticos.forEach(ponto => {
        console.log(`   üö© ${ponto.etapa}: ${ponto.percentual}% dos abandonos`);
      });
    } else {
      console.log('   ‚úÖ Nenhum ponto cr√≠tico identificado');
    }
  }

  // 9. Calcular pontua√ß√£o
  console.log('\nüéØ PONTUA√á√ÉO FINAL:');
  let score = 0;
  if (formulaIsCorrect) score += 30;
  if (isInRange) score += 20;
  if (hasValidData) score += 20;
  if (meetsRequirement) score += 30;

  console.log(`   F√≥rmula correta: ${formulaIsCorrect ? '+30' : '+0'}`);
  console.log(`   Range v√°lido: ${isInRange ? '+20' : '+0'}`);
  console.log(`   Dados consistentes: ${hasValidData ? '+20' : '+0'}`);
  console.log(`   Atende requisito: ${meetsRequirement ? '+30' : '+0'}`);
  console.log(`   üìä PONTUA√á√ÉO TOTAL: ${score}/100`);

  // 10. Resultado final
  console.log('\nüéä RESULTADO FINAL:');
  if (score >= 80) {
    console.log('%c‚úÖ M√âTRICA VALIDADA COM SUCESSO!', 'color: green; font-size: 16px; font-weight: bold;');
    console.log('%cA M√©trica de Usabilidade 3 est√° funcionando corretamente.', 'color: green;');
  } else {
    console.log('%c‚ùå M√âTRICA N√ÉO VALIDADA', 'color: red; font-size: 16px; font-weight: bold;');
    console.log('%cA m√©trica precisa de ajustes antes de ser considerada v√°lida.', 'color: red;');
  }

  // 11. Recomenda√ß√µes espec√≠ficas
  console.log('\nüí° RECOMENDA√á√ïES ESPEC√çFICAS:');
  if (AT === 0) {
    console.log('   üéØ Sistema sem dados de abandono:');
    console.log('   - Implemente rastreamento de abandonos');
    console.log('   - Monitore sa√≠das durante o fluxo');
    console.log('   - Registre etapas onde usu√°rios desistem');
  } else if (!meetsRequirement) {
    console.log('   üîß Para reduzir a taxa de abandono:');
    
    if (abandonoData.pontoCritico) {
      console.log(`   üéØ Foco principal: ${abandonoData.pontoCritico}`);
    }
    
    console.log('   - Simplificar formul√°rios complexos');
    console.log('   - Reduzir n√∫mero de etapas obrigat√≥rias');
    console.log('   - Oferecer salvar rascunho do agendamento');
    console.log('   - Mostrar progresso claro do processo');
    console.log('   - Implementar reten√ß√£o em sa√≠das (exit-intent)');
  } else {
    console.log('   ‚úÖ Sistema com excelente reten√ß√£o de usu√°rios!');
    console.log('   - Continue monitorando a taxa de abandono');
    console.log('   - Mantenha a experi√™ncia atual');
  }

  return {
    score,
    isValid: score >= 80,
    meetsRequirement,
    metrics: { AA, AT, x },
    details: {
      formulaIsCorrect,
      isInRange, 
      hasValidData,
      taxaConversao: (100 - x).toFixed(1)
    }
  };
};

// Fun√ß√£o para coletar dados de abandono do sistema
const collectAbandonoData = () => {
  let agendamentosAbandonados = 0;
  let totalTentativas = 0;
  let abandonosPorEtapa = [];
  let causasAbandono = [];

  try {
    // 1. Tentar encontrar dados de abandono em v√°rios locais
    const possibleDataSources = [
      'metricas_abandono',
      'abandonos_agendamento',
      'fluxo_conversao',
      'analise_usuarios',
      'dados_retencao'
    ];

    for (const source of possibleDataSources) {
      const data = localStorage.getItem(source);
      if (data) {
        console.log(`   üìÅ Encontrado dados em: ${source}`);
        const parsedData = JSON.parse(data);
        
        if (parsedData.agendamentosAbandonados !== undefined) {
          agendamentosAbandonados = parsedData.agendamentosAbandonados;
          totalTentativas = parsedData.totalTentativas;
          abandonosPorEtapa = parsedData.abandonosPorEtapa || [];
          causasAbandono = parsedData.causasAbandono || [];
          break;
        }
      }
    }

    // 2. Se n√£o encontrou dados espec√≠ficos, tentar calcular baseado em sess√µes
    if (totalTentativas === 0) {
      console.log('   üîç Calculando abandonos baseado em sess√µes...');
      
      // Verificar sess√µes iniciadas vs conclu√≠das
      const sessoesIniciadas = JSON.parse(localStorage.getItem('sessoes_agendamento') || '[]');
      const agendamentosConcluidos = JSON.parse(localStorage.getItem('agendamentos') || '[]');
      
      if (sessoesIniciadas.length > 0) {
        totalTentativas = sessoesIniciadas.length;
        agendamentosAbandonados = totalTentativas - agendamentosConcluidos.length;
        
        // Estimar abandonos por etapa baseado no tempo
        abandonosPorEtapa = estimarAbandonosPorEtapa(sessoesIniciadas);
      }
    }

  } catch (error) {
    console.log('   ‚ö†Ô∏è Erro ao acessar dados de abandono, usando dados de teste');
  }

  // Se n√£o encontrou dados suficientes, usar dados de teste realistas
  if (totalTentativas === 0) {
    return generateRealisticAbandonoData();
  }

  const taxaAbandono = totalTentativas > 0 ? (agendamentosAbandonados / totalTentativas) * 100 : 0;
  
  // Identificar ponto cr√≠tico
  const pontoCritico = identificarPontoCritico(abandonosPorEtapa);

  return {
    agendamentosAbandonados,
    totalTentativas,
    taxaAbandono,
    abandonosPorEtapa,
    causasAbandono,
    pontoCritico
  };
};

// Fun√ß√£o para estimar abandonos por etapa
const estimarAbandonosPorEtapa = (sessoes) => {
  const etapas = [
    { etapa: 'preenchimento_dados', taxa: 0.3 },
    { etapa: 'selecao_servico', taxa: 0.2 },
    { etapa: 'escolha_horario', taxa: 0.4 },
    { etapa: 'confirmacao_pagamento', taxa: 0.1 }
  ];

  const totalAbandonos = sessoes.length - JSON.parse(localStorage.getItem('agendamentos') || '[]').length;
  
  return etapas.map(etapa => ({
    etapa: etapa.etapa,
    quantidade: Math.round(totalAbandonos * etapa.taxa),
    percentual: (etapa.taxa * 100).toFixed(1)
  }));
};

// Fun√ß√£o para identificar ponto cr√≠tico
const identificarPontoCritico = (abandonosPorEtapa) => {
  if (abandonosPorEtapa.length === 0) return null;
  
  const pontoMaisCritico = abandonosPorEtapa.reduce((prev, current) => 
    (prev.percentual > current.percentual) ? prev : current
  );
  
  return pontoMaisCritico.percentual > 20 ? pontoMaisCritico.etapa : null;
};

// Gerar dados de teste REALISTAS para abandono
const generateRealisticAbandonoData = () => {
  const totalTentativas = 85;
  const agendamentosAbandonados = 7; // 8.2% de abandono (acima do ideal)
  
  const abandonosPorEtapa = [
    { etapa: 'preenchimento_dados', quantidade: 2, percentual: '28.6' },
    { etapa: 'selecao_servico', quantidade: 1, percentual: '14.3' },
    { etapa: 'escolha_horario', quantidade: 3, percentual: '42.9' },
    { etapa: 'confirmacao_pagamento', quantidade: 1, percentual: '14.3' }
  ];
  
  const causasAbandono = [
    { causa: 'formul√°rio muito longo', quantidade: 3 },
    { causa: 'hor√°rios indispon√≠veis', quantidade: 2 },
    { causa: 'd√∫vidas n√£o resolvidas', quantidade: 1 },
    { causa: 'problemas t√©cnicos', quantidade: 1 }
  ];
  
  const taxaAbandono = (agendamentosAbandonados / totalTentativas) * 100;
  const pontoCritico = 'escolha_horario'; // Ponto mais cr√≠tico

  return {
    agendamentosAbandonados,
    totalTentativas,
    taxaAbandono,
    abandonosPorEtapa,
    causasAbandono,
    pontoCritico
  };
};

// Sistema de rastreamento de abandono em tempo real
const AbandonoTracker = {
  // Iniciar sess√£o de agendamento
  iniciarSessao: function(usuarioId = null) {
    const sessao = {
      id: Date.now(),
      usuarioId: usuarioId,
      inicio: new Date().toISOString(),
      etapas: [],
      abandonada: false
    };
    
    const sessoesAtivas = JSON.parse(localStorage.getItem('sessoes_agendamento_ativas') || '[]');
    sessoesAtivas.push(sessao);
    localStorage.setItem('sessoes_agendamento_ativas', JSON.stringify(sessoesAtivas));
    
    console.log('üìä Sess√£o de agendamento iniciada');
    return sessao.id;
  },
  
  // Registrar progresso na etapa
  registrarEtapa: function(sessaoId, etapa) {
    const sessoesAtivas = JSON.parse(localStorage.getItem('sessoes_agendamento_ativas') || '[]');
    const sessao = sessoesAtivas.find(s => s.id === sessaoId);
    
    if (sessao) {
      sessao.etapas.push({
        etapa: etapa,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('sessoes_agendamento_ativas', JSON.stringify(sessoesAtivas));
    }
  },
  
  // Finalizar sess√£o com sucesso
  finalizarComSucesso: function(sessaoId) {
    this.finalizarSessao(sessaoId, false);
    console.log('‚úÖ Agendamento conclu√≠do com sucesso');
  },
  
  // Registrar abandono
  registrarAbandono: function(sessaoId, causa = 'saida_voluntaria', etapaAtual = null) {
    this.finalizarSessao(sessaoId, true, causa, etapaAtual);
    console.log('üö™ Abandono registrado');
  },
  
  // Finalizar sess√£o (internal)
  finalizarSessao: function(sessaoId, abandonada, causa = null, etapaAtual = null) {
    const sessoesAtivas = JSON.parse(localStorage.getItem('sessoes_agendamento_ativas') || '[]');
    const sessaoIndex = sessoesAtivas.findIndex(s => s.id === sessaoId);
    
    if (sessaoIndex !== -1) {
      const sessao = sessoesAtivas[sessaoIndex];
      sessao.fim = new Date().toISOString();
      sessao.abandonada = abandonada;
      sessao.causaAbandono = causa;
      sessao.etapaAbandono = etapaAtual;
      sessao.duracao = new Date(sessao.fim) - new Date(sessao.inicio);
      
      // Mover para hist√≥rico
      const historico = JSON.parse(localStorage.getItem('sessoes_agendamento_historico') || '[]');
      historico.push(sessao);
      localStorage.setItem('sessoes_agendamento_historico', JSON.stringify(historico));
      
      // Remover das ativas
      sessoesAtivas.splice(sessaoIndex, 1);
      localStorage.setItem('sessoes_agendamento_ativas', JSON.stringify(sessoesAtivas));
    }
  },
  
  // Detectar sa√≠das automaticamente
  configurarDetectorSaidas: function() {
    window.addEventListener('beforeunload', function(e) {
      const sessoesAtivas = JSON.parse(localStorage.getItem('sessoes_agendamento_ativas') || '[]');
      if (sessoesAtivas.length > 0) {
        // Registrar abandono para sess√µes ativas
        sessoesAtivas.forEach(sessao => {
          AbandonoTracker.registrarAbandono(sessao.id, 'fechar_pagina', sessao.etapas[sessao.etapas.length - 1]?.etapa);
        });
      }
    });
    
    console.log('üîç Detector de sa√≠das configurado');
  }
};

// Fun√ß√£o para simular dados de BAIXO ABANDONO (ideal)
const simularDadosBaixoAbandono = () => {
  console.log('üéØ SIMULANDO DADOS DE BAIXO ABANDONO...');
  
  const metricasAbandono = {
    agendamentosAbandonados: 4,
    totalTentativas: 100, // 4% de abandono (dentro do requisito)
    abandonosPorEtapa: [
      { etapa: 'preenchimento_dados', quantidade: 1, percentual: '25.0' },
      { etapa: 'selecao_servico', quantidade: 1, percentual: '25.0' },
      { etapa: 'escolha_horario', quantidade: 1, percentual: '25.0' },
      { etapa: 'confirmacao_pagamento', quantidade: 1, percentual: '25.0' }
    ],
    causasAbandono: [
      { causa: 'mudan√ßa de ideia', quantidade: 2 },
      { causa: 'hor√°rio indispon√≠vel', quantidade: 1 },
      { causa: 'emerg√™ncia', quantidade: 1 }
    ]
  };

  localStorage.setItem('metricas_abandono', JSON.stringify(metricasAbandono));
  
  console.log('‚úÖ Dados de baixo abandono simulados!');
  console.log('   - 4% de taxa de abandono (dentro do requisito ‚â§5%)');
  console.log('   - Distribui√ß√£o equilibrada entre etapas');
};

// Executar a valida√ß√£o
console.log('üöÄ Executando valida√ß√£o da M√©trica de Usabilidade 3...');
const results = validateUsabilityMetric3();

// Expor fun√ß√µes para uso no console
window.validateUsabilityMetric3 = validateUsabilityMetric3;
window.simularDadosBaixoAbandono = simularDadosBaixoAbandono;
window.AbandonoTracker = AbandonoTracker;

console.log('\nüí° COMANDOS DISPON√çVEIS:');
console.log('   validateUsabilityMetric3() - Reexecutar valida√ß√£o');
console.log('   simularDadosBaixoAbandono() - Criar dados de baixo abandono');
console.log('   AbandonoTracker.iniciarSessao() - Iniciar rastreamento');
console.log('   AbandonoTracker.registrarEtapa() - Registrar progresso');
console.log('   AbandonoTracker.finalizarComSucesso() - Concluir agendamento');
console.log('   AbandonoTracker.registrarAbandono() - Registrar abandono');